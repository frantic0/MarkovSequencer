<!DOCTYPE HTML>
<html>

<head>
  <meta charset="utf-8">
  <link href="style.css" type="text/css" rel="stylesheet">
</head>

<body>
  <div style="margin: 30px 30px 30px 30px;">

    <div>
      <h1>Markov Sequencer</h1>
    <div><!-- <p>Markov &gt; Files</p> -->


    <div>
      <p>Markov explanation</p>
    </div>

    <div>
      <div style="clear:left;">
        <audio id="909b">
          <source src="./samples/909b.wav" type="audio/wav">
        </audio>
        <button id="909b" class="sampleButtons" onclick="playSample(this)">▶</button>
        <div style="float: left; margin-right: 10px">k = kick drum</div>
      </div>

      <div style="clear:left;">
        <audio id="909">
            <source src="./samples/909.wav" type="audio/wav">
        </audio>
        <button id="909" class="sampleButtons" onclick="playSample(this)">▶</button>
        <div style="float: left; margin-right: 10px">s = snare drum</div>
      </div>

      <div style="clear:left;">
        <audio id="909open">
          <source src="./samples/909open.wav" type="audio/wav">
        </audio>
        <button id="909open" class="sampleButtons" onclick="playSample(this)">▶</button>
        <div style="float: left; margin-right: 10px">c = closed hi-hat</div>
      </div>

      <div style="clear:left;">
        <audio id="909closed">
          <source src="./samples/909closed.wav" type="audio/wav">
        </audio>
        <button id="909closed" class="sampleButtons"  onclick="playSample(this)">▶</button>
        <div style="float: left; margin-right: 10px">o = open hi-hat</div>
      </div>
    </div>

    &nbsp;
    <div>
      <p>Markov Generator</p>
      <textarea id="ta_patterns" value="" cols="40" rows="5" onkeyup="getPatternChanges()"></textarea>
    </div>
    <div>
      <button type="button" id="btn1" onclick="btn1_loadData()">LOAD DATA</button>
      <!-- <button type="button" id="btn2" onclick="btn2_train()">TRAIN</button> -->
      <button type="button" id="btn3" onclick="btn3_delete()">DELETE</button>
    </div>
    <div>
      <p>Drum Sequence</p>
      <textarea id="ta_sequence" value="sdfsdf" cols="40" rows="5" onkeyup="getSeqChanges()"></textarea>
    </div>

    <div>
      <button type="button" id="btn6" style="float: left; margin-right: 5px; color: white; background-color: #4CAF50;" onclick="btn6_play()">▶</button>
      <button type="button" id="btn4" style="float: left; margin-right: 5px" onclick="btn4_addData()">ADD DATA</button>
      <button type="button" id="btn5" style="float: left; margin-right: 5px" onclick="btn5_generate()">GENERATE</button>
    </div>
    <p></p>
    &nbsp;
    &nbsp;
    <div>
      <div>
        <div style="float: left; margin-right: 10px">playing &gt; </div>
        <div style="float: left;" id="console"> </div>
      </div>

      <div style="clear:left;">
        <div style="float: left; margin-right: 10px">gen &gt; </div>
        <div style="float: left;" id="gen_console"> </div>
      </div>
    </div>


    <p></p>
    &nbsp;
    &nbsp;

  </div>

  <!--<div id="console"></div>-->
  <!-- <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@0.14.1/dist/tf.min.js"></script> -->

</body>
<script src="./maxiLib.js"></script>
<!-- <script src="https://nickersoft.github.io/markov.js/node_modules/markov.js/markov.min.js"></script> -->
<!-- <script src="./markov.min.js"></script> -->
<script src="./markov.js"></script>
<script>
  /// Markov Model //////////////////////////////////

  var markov = new Markov();

  let isPlaying = false;

  /// Global vars (hackit!)  //////////////////////////////////

  var patterns = "kccc bcc bcc kccs bcc kccs kccs bcc kcco kccs skos kkok ccs koss kssooc bcc skos";
  var sequence = "kc kc k shos";
  var synth = 0;
  // var sequence = "ksc-cccckc-k-shos";

  var modelOutput = "";

  /// UI handlers //////////////////////////////////

  (function setup() {
    document.getElementById("ta_patterns").value = patterns;
    markov.add(patterns);
    document.getElementById("ta_sequence").value = sequence;
    document.getElementById("console").innerHTML = sequence;
  })();
  // setup();

  /* Grab text sequence */
  function getSeqChanges() {
    sequence = document.getElementById("ta_sequence").value;
    document.getElementById("console").innerHTML = sequence;
    // console.log(sequence);

    if(!isNaN(parseInt(sequence)))
      synth = parseInt(sequence)

    console.log(synth);
  }

  function getPatternChanges() {
    patterns = document.getElementById("ta_patterns").value;
    document.getElementById("ta_patterns").innerHTML = patterns;
  }

  function btn1_loadData() {
    patterns = document.getElementById("source").value;
    markov = new Markov();
    markov.add(patterns);
  }

  function btn2_train() {
    console.log(patterns);
  }

  function btn3_delete() {
    patterns = "";
    document.getElementById("ta_patterns").value = patterns;
    markov = new Markov();
  }

  function btn4_addData() {
    // patterns += sequence + "&#013;&#010;"; // to add breakline to text content of TextArea
    markov.add(sequence);
    patterns += " " + sequence;
    document.getElementById("ta_patterns").value = patterns;
  }

  function btn5_generate() {
    sequence = markov.generate();
    document.getElementById("console").innerHTML = sequence;
  }

  function playSample(e) {
    let x = document.getElementById(e.id);
    // alert(e.id);
    x.play();
  }


  function btn6_play(){

    if(!initialised) init();

    if(!isPlaying) play(mixer);
    else play( () => { return 0; } ); // Shut up Maxi by injecting 0 in output

    isPlaying = !isPlaying;

    let btn6 = document.getElementById("btn6");
    let playing = () => { btn6.innerText = "■"; btn6.style.backgroundColor = "red";}
    let stopped = () => { btn6.innerText = "▶"; btn6.style.backgroundColor = "#4CAF50";}

    (() => isPlaying ? playing() : stopped() )();
  }


  /// Maxi Audio Engine  //////////////////////////////////

  var maxiAudio = new maximJs.maxiAudio();

  var tempo = 120.0; // tempo (in beats per minute);
  var secondsPerBeat = (60.0 / tempo);
  var counterTimeValue = (secondsPerBeat / 4); //___16th note
  var clock = new maximJs.maxiOsc();

  var kick = new maximJs.maxiSample();
  var snare = new maximJs.maxiSample();
  var closedHat = new maximJs.maxiSample();
  var openHat = new maximJs.maxiSample();

  var mySine = new maximJs.maxiOsc();
  var myOtherSine = new maximJs.maxiOsc();
  var myLastSine = new maximJs.maxiOsc();

  var oldClock = 0;
  var phase = 0;

  let initialised = false;

  function init(){

    maxiAudio.init();

    // 	var sample = new maximJs.maxiSample();
    maxiAudio.loadSample("./samples/909b.wav", kick);
    maxiAudio.loadSample("./samples/909.wav", snare);
    maxiAudio.loadSample("./samples/909closed.wav", closedHat);
    maxiAudio.loadSample("./samples/909open.wav", openHat);

    initialised = true;
  }


  function loopPlayer() {

    var now = clock.sinewave(7);

    if (oldClock <= 0 && now > 0) {

      var sampleSelector = sequence[phase++ % sequence.length];

      switch (sampleSelector) {
        case "k":
          kick.trigger();
          break;
        case "s":
          snare.trigger();
          break;
        case "o":
          openHat.trigger();
          break;
        case "c":
          closedHat.trigger();
          break;
      }
    }

    oldClock = now;

    var w = 0.0;

    if (kick.isReady()) {
      w += kick.playOnce();
    }
    if (snare.isReady()) {
      w += snare.playOnce();
    }
    if (closedHat.isReady()) {
      w += closedHat.playOnce();
    }
    if (openHat.isReady()) {
      w += openHat.playOnce();
    }
    return w;
  }

  function synComposer(n) {

    var synOut;

    return synOut;
  }


  function synSelector(n) {

    var synOut;

    switch (n) {
      case 0:
        // Hello world
        synOut = mySine.sinewave(440);
        break;
      case 1:
        // Beating
        synOut = mySine.sinewave(440) + myOtherSine.sinewave(441);
        break;
      case 2:
        // Amplitude Modulation
        synOut = mySine.sinewave(440) * myOtherSine.sinewave(1);
        break;
      case 3:
        // Frequency Modulation
        synOut = mySine.sinewave(440 + (myOtherSine.sinewave(1)*100));
        break;
      case 4:
        synOut = mySine.sinewave(myOtherSine.sinewave(30) * 440);
        break;
      case 5:
        synOut = mySine.sinewave(myOtherSine.sinewave(myLastSine.sinewave(0.1) * 30) * 440);
        break;
      // default:
      //   synOut = mySine.sinewave(myOtherSine.sinewave(myLastSine.sinewave(0.1) * 30) * 440);
    }
    return synOut;
  }

  function mixer() {
    return loopPlayer() + synSelector(synth);
  }

  function play(f) {

    maxiAudio.play = function() {
      this.output = f();
    };
  };

  play(mixer);

</script>

</html>
